<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YT Custom Player - 多格播放清單版 (Compact)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #0f0f0f;
      color: #ddd;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: 240px;
      background: #181818;
      border-right: 1px solid #333;
      padding: 12px 8px;
      overflow-y: auto;
      font-size: 0.9rem;

      /* Firefox 滾動條樣式 */
      scrollbar-width: thin;
      scrollbar-color: #555 #181818;
    }

    /* Chrome / Edge / Safari / 新版 Opera 滾動條樣式 */
    #sidebar::-webkit-scrollbar {
      width: 8px;
    }

    #sidebar::-webkit-scrollbar-track {
      background: #181818;
      border-radius: 4px;
    }

    #sidebar::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
      border: 2px solid #181818; /* 製造內縮邊框感，更精緻 */
    }

    #sidebar::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    #sidebar::-webkit-scrollbar-thumb:active {
      background: #999;
    }

    #sidebar h2 {
      margin-bottom: 10px;
      color: white;
      font-size: 1.1rem;
    }

    .playlist-item {
      padding: 6px 10px;
      margin-bottom: 4px;
      background: #282828;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.85rem;
      line-height: 1.2;
    }

    .playlist-item:hover {
      background: #383838;
    }

    .playlist-item:active {
      background: #065fd4;
    }

    #main {
      flex: 1;
      background: #000;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      padding: 10px 20px;
      border-radius: 30px;
      z-index: 100;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      max-width: 90%;
      opacity: 1;
      transition: opacity 0.6s ease;
      pointer-events: auto;
    }

    #controls.hidden {
      opacity: 0;
      pointer-events: none;
    }

    button {
      padding: 8px 12px;
      background: #065fd4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.9rem;
    }

    button:hover {
      background: #0a73e6;
    }

    #grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 10px;
      padding: 15px;
      overflow-y: auto;
    }

    .video-wrapper {
      position: relative;
      background: #111;
      border-radius: 6px;
      overflow: hidden;
      aspect-ratio: 16 / 9;
    }

    .video-wrapper iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }

    .close-btn:hover {
      background: #c00;
    }

    #no-video-msg {
      color: #777;
      font-size: 1.4rem;
      text-align: center;
      margin: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <aside id="sidebar">
      <h2>播放清單</h2>
      <div id="playlist-items"></div>
    </aside>

    <main id="main">
      <div id="controls">
        <input type="file" id="load-json" accept=".json" style="display:none" />
        <button onclick="document.getElementById('load-json').click()">載入 JSON 檔案</button>
        <button onclick="loadJsonFromUrl()">載入 JSON URL</button>
        <button onclick="addVideoManually()">加入影片</button>
        <button onclick="savePlaylist()">儲存目前清單</button>
        <button onclick="clearPlaylist()">清除清單</button>
        <button onclick="playAll()">全部播放</button>
        <button onclick="pauseAll()">全部暫停</button>
        <button onclick="toggleMuteAll()">靜音/取消靜音</button>
      </div>

      <div id="grid"></div>
      <div id="no-video-msg">請從左側播放清單選擇影片加入播放</div>
    </main>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // 全域變數
    let currentPlaylist = [];
    let players = {};
    let isMuted = true;

    const controls = document.getElementById("controls");
    let hideTimer = null;

    function showControls() {
      controls.classList.remove("hidden");
      clearTimeout(hideTimer);
      hideTimer = setTimeout(() => {
        controls.classList.add("hidden");
      }, 3000);
    }

    document.addEventListener("mousemove", showControls);
    document.addEventListener("click", showControls);

    function onYouTubeIframeAPIReady() {
      console.log("YouTube IFrame API Ready");
      showControls();
    }

    async function loadJsonFromUrl() {
      const defaultUrl = "https://raw.githubusercontent.com/alanfox2000software/ytcustomplayer/refs/heads/main/playlist.json";
      const url = prompt("請輸入 JSON 檔案的完整網址（支援 CORS 的公開連結）：", defaultUrl);
      if (!url) return;

      try {
        showControls();
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP 錯誤：${response.status}`);

        const data = await response.json();

        currentPlaylist = data
          .map(item => ({
            title: item.title || "未命名",
            id: item.id || extractId(item.url || ""),
          }))
          .filter(item => item.id);

        renderPlaylist();
        alert(`從 URL 成功載入 ${currentPlaylist.length} 個項目`);
      } catch (err) {
        alert("載入失敗：\n" + err.message + "\n\n可能原因：\n1. 網址錯誤\n2. 該網站未開啟 CORS\n3. JSON 格式不正確");
      }
    }

    function addVideoManually() {
      const title = prompt("請輸入影片標題：");
      if (!title) return;

      const url = prompt("請輸入 YouTube 網址：");
      if (!url) return;

      const videoId = extractId(url);
      if (!videoId) {
        alert("無法解析出有效的 YouTube 影片 ID");
        return;
      }

      if (currentPlaylist.some(item => item.id === videoId)) {
        alert("此影片已經在播放清單中");
        return;
      }

      currentPlaylist.push({ title, id: videoId });
      renderPlaylist();
      alert(`已加入：「${title}」`);
      showControls();
    }

    function loadSavedPlaylist() {
      const saved = localStorage.getItem("ytCustomPlaylist");
      if (saved) {
        try {
          currentPlaylist = JSON.parse(saved);
          renderPlaylist();
        } catch (e) {}
      }
    }

    function renderPlaylist() {
      const container = document.getElementById("playlist-items");
      container.innerHTML = "";

      currentPlaylist.forEach((item, i) => {
        const div = document.createElement("div");
        div.className = "playlist-item";
        div.textContent = item.title || `影片 ${i + 1}`;
        div.dataset.id = item.id;
        div.onclick = () => addVideoToGrid(item.id);
        container.appendChild(div);
      });
    }

    function addVideoToGrid(videoId) {
      if (players[videoId]) return;

      document.getElementById("no-video-msg").style.display = "none";

      const wrapper = document.createElement("div");
      wrapper.className = "video-wrapper";
      wrapper.id = `wrapper-${videoId}`;

      const closeBtn = document.createElement("button");
      closeBtn.className = "close-btn";
      closeBtn.textContent = "×";
      closeBtn.onclick = () => removeVideo(videoId);
      wrapper.appendChild(closeBtn);

      const playerDiv = document.createElement("div");
      playerDiv.id = `player-${videoId}`;
      wrapper.appendChild(playerDiv);

      document.getElementById("grid").appendChild(wrapper);

      const p = new YT.Player(`player-${videoId}`, {
        height: "100%",
        width: "100%",
        videoId: videoId,
        playerVars: {
          autoplay: 1,
          mute: isMuted ? 1 : 0,
          rel: 0,
          modestbranding: 1,
        },
        events: {
          onReady: (e) => e.target.playVideo(),
        },
      });

      players[videoId] = p;
    }

    function removeVideo(videoId) {
      const wrapper = document.getElementById(`wrapper-${videoId}`);
      if (wrapper) {
        if (players[videoId]) {
          players[videoId].destroy();
          delete players[videoId];
        }
        wrapper.remove();

        if (Object.keys(players).length === 0) {
          document.getElementById("no-video-msg").style.display = "flex";
        }
      }
    }

    function playAll() {
      Object.values(players).forEach(p => p?.playVideo?.());
      showControls();
    }

    function pauseAll() {
      Object.values(players).forEach(p => p?.pauseVideo?.());
      showControls();
    }

    function toggleMuteAll() {
      isMuted = !isMuted;
      Object.values(players).forEach(p => {
        if (isMuted) p?.mute?.();
        else p?.unMute?.();
      });
      showControls();
    }

    document.getElementById("load-json").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          currentPlaylist = data
            .map(item => ({
              title: item.title || "未命名",
              id: item.id || extractId(item.url || ""),
            }))
            .filter(item => item.id);

          renderPlaylist();
          alert(`已載入 ${currentPlaylist.length} 個項目`);
          showControls();
        } catch (err) {
          alert("JSON 格式錯誤：" + err.message);
        }
      };
      reader.readAsText(file);
    });

    function savePlaylist() {
      if (currentPlaylist.length === 0) return alert("沒有清單可儲存");
      localStorage.setItem("ytCustomPlaylist", JSON.stringify(currentPlaylist));
      alert("已儲存至瀏覽器");
      showControls();
    }

    function clearPlaylist() {
      if (!confirm("確定清除播放清單？")) return;
      currentPlaylist = [];
      localStorage.removeItem("ytCustomPlaylist");
      renderPlaylist();
      showControls();
    }

    function extractId(url) {
      const m = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);
      return m ? m[1] : "";
    }

    window.addEventListener("load", () => {
      loadSavedPlaylist();
    });
  </script>
</body>
</html>
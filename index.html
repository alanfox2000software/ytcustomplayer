<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YT Custom Player - Playlist Enhanced</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #0f0f0f;
      color: #ddd;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: 320px;
      background: #181818;
      border-right: 1px solid #333;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #sidebar h2 {
      margin-bottom: 15px;
      color: white;
    }

    .playlist-item {
      padding: 10px 12px;
      margin-bottom: 8px;
      background: #282828;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.2s;
    }

    .playlist-item:hover,
    .playlist-item.active {
      background: #065fd4;
      color: white;
    }

    .sidebar-controls {
      margin-top: auto;
      padding-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    button {
      padding: 8px 12px;
      background: #065fd4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #0a73e6;
    }

    #main {
      flex: 1;
      position: relative;
      background: #000;
      display: flex;
      flex-direction: column;
    }

    #controls {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: 8px 16px;
      border-radius: 20px;
      z-index: 10;
      display: flex;
      gap: 15px;
      color: white;
    }

    #grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 8px;
      padding: 10px;
      overflow: auto;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    #player-single {
      width: 90%;
      max-width: 1280px;
      aspect-ratio: 16 / 9;
      margin: auto;
      background: #000;
    }

    #no-video-msg {
      color: #777;
      font-size: 1.3rem;
      text-align: center;
      margin: auto;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 左側播放清單側邊欄 -->
    <aside id="sidebar">
      <h2>播放清單</h2>
      <div id="playlist-items"></div>

      <div class="sidebar-controls">
        <input type="file" id="load-json" accept=".json" style="display:none" />
        <button onclick="document.getElementById('load-json').click()">
          載入 JSON 清單
        </button>
        <button onclick="savePlaylist()">儲存目前清單</button>
        <button onclick="clearPlaylist()">清除清單</button>
      </div>
    </aside>

    <!-- 主要區域 -->
    <main id="main">
      <div id="controls">
        <button onclick="playAll()">全部播放</button>
        <button onclick="pauseAll()">全部暫停</button>
        <button onclick="toggleMuteAll()">靜音/取消靜音</button>
        <button onclick="toggleFullscreen()">全螢幕</button>
      </div>

      <!-- 多影片網格模式（原有） -->
      <div id="grid" class="hidden"></div>

      <!-- 單一影片模式（新） -->
      <div id="player-single" class="hidden"></div>

      <div id="no-video-msg">請從左側選擇影片，或使用 ?videos=xxx,yyy 網址參數</div>
    </main>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // ==================== 全域變數 ====================
    let currentPlaylist = [];
    let singlePlayer = null;
    let currentPlayingId = null;
    let players = []; // 多影片模式用的 Player 陣列
    let isMuted = true;

    // ==================== YouTube API 準備好 ====================
    function onYouTubeIframeAPIReady() {
      // 只註冊 API，實際建立 player 時再呼叫
      console.log("YouTube IFrame API Ready");
    }

    // ==================== 播放清單管理 ====================
    function loadSavedPlaylist() {
      const saved = localStorage.getItem("ytCustomPlaylist");
      if (saved) {
        try {
          currentPlaylist = JSON.parse(saved);
          renderPlaylist();
        } catch (e) {}
      }
    }

    function renderPlaylist() {
      const container = document.getElementById("playlist-items");
      container.innerHTML = "";

      currentPlaylist.forEach((item, i) => {
        const div = document.createElement("div");
        div.className = "playlist-item";
        div.textContent = item.title || `影片 ${i + 1}`;
        div.dataset.id = item.id;
        div.onclick = () => playSingleVideo(item.id, div);
        container.appendChild(div);
      });

      updateActiveItem();
    }

    function updateActiveItem() {
      document.querySelectorAll(".playlist-item").forEach((el) => {
        el.classList.toggle("active", el.dataset.id === currentPlayingId);
      });
    }

    // ==================== 單一影片播放 ====================
    function playSingleVideo(videoId, element) {
      if (!videoId) return;

      // 切換顯示模式
      document.getElementById("grid").classList.add("hidden");
      document.getElementById("player-single").classList.remove("hidden");
      document.getElementById("no-video-msg").classList.add("hidden");

      // 銷毀舊 player
      if (singlePlayer) {
        singlePlayer.destroy();
        singlePlayer = null;
      }

      currentPlayingId = videoId;
      updateActiveItem();

      singlePlayer = new YT.Player("player-single", {
        height: "100%",
        width: "100%",
        videoId: videoId,
        playerVars: {
          autoplay: 1,
          mute: isMuted ? 1 : 0,
          rel: 0,
          modestbranding: 1,
        },
        events: {
          onReady: (e) => e.target.playVideo(),
        },
      });
    }

    // ==================== 原有多影片模式 ====================
    function loadFromUrl() {
      const params = new URLSearchParams(location.search);
      const videos = params.get("videos");
      if (!videos) return false;

      const ids = videos.split(",").map((id) => id.trim()).filter(Boolean);
      if (ids.length === 0) return false;

      // 顯示網格模式
      document.getElementById("grid").classList.remove("hidden");
      document.getElementById("player-single").classList.add("hidden");
      document.getElementById("no-video-msg").classList.add("hidden");

      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      players = [];

      ids.forEach((id) => {
        const div = document.createElement("div");
        grid.appendChild(div);

        const p = new YT.Player(div, {
          height: "100%",
          width: "100%",
          videoId: id,
          playerVars: {
            autoplay: 1,
            mute: 1,
            rel: 0,
          },
        });
        players.push(p);
      });

      return true;
    }

    function playAll() {
      players.forEach((p) => p?.playVideo?.());
      if (singlePlayer) singlePlayer.playVideo();
    }

    function pauseAll() {
      players.forEach((p) => p?.pauseVideo?.());
      if (singlePlayer) singlePlayer.pauseVideo();
    }

    function toggleMuteAll() {
      isMuted = !isMuted;
      players.forEach((p) => {
        if (isMuted) p?.mute?.();
        else p?.unMute?.();
      });
      if (singlePlayer) {
        if (isMuted) singlePlayer.mute();
        else singlePlayer.unMute();
      }
    }

    function toggleFullscreen() {
      const elem = document.getElementById("main");
      if (!document.fullscreenElement) {
        elem.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    }

    // ==================== JSON 處理 ====================
    document.getElementById("load-json").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          currentPlaylist = data
            .map((item) => ({
              title: item.title || "未命名",
              id: item.id || extractId(item.url || ""),
            }))
            .filter((item) => item.id);

          renderPlaylist();
          alert(`已載入 ${currentPlaylist.length} 個項目`);
        } catch (err) {
          alert("JSON 格式錯誤：" + err.message);
        }
      };
      reader.readAsText(file);
    });

    function savePlaylist() {
      if (currentPlaylist.length === 0) return alert("沒有清單可儲存");
      localStorage.setItem("ytCustomPlaylist", JSON.stringify(currentPlaylist));
      alert("已儲存至瀏覽器");
    }

    function clearPlaylist() {
      if (!confirm("確定清除播放清單？")) return;
      currentPlaylist = [];
      localStorage.removeItem("ytCustomPlaylist");
      renderPlaylist();

      // 清空單一播放器
      if (singlePlayer) {
        singlePlayer.destroy();
        singlePlayer = null;
      }
      currentPlayingId = null;
      document.getElementById("no-video-msg").classList.remove("hidden");
      document.getElementById("player-single").classList.add("hidden");
    }

    function extractId(url) {
      const m = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);
      return m ? m[1] : "";
    }

    // ==================== 初始化 ====================
    window.addEventListener("load", () => {
      loadSavedPlaylist();
      const loaded = loadFromUrl();
      if (!loaded && currentPlaylist.length > 0) {
        // 如果沒有 ?videos= 參數，但有儲存的清單，可選擇預設不自動播放
        renderPlaylist();
      }
    });
  </script>
</body>
</html>
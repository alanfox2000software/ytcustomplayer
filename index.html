<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>YouTube Multiplayer</title>
        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
		.container {
			display: flex;
			height: 100vh;
		}
		#sidebar {
			width: 280px;
			background: #1e1e1e;
			color: white;
			padding: 15px;
			overflow-y: auto;
			border-right: 1px solid #333;
		}
		#main-grid {
			flex: 1;
			padding: 10px;
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
			gap: 10px;
			overflow-y: auto;
		}
		.playlist-item {
			padding: 10px;
			cursor: pointer;
			background: #2d2d2d;
			margin-bottom: 8px;
			border-radius: 4px;
		}
		.playlist-item:hover,
		.playlist-item.active {
			background: #4a4a4a;
		}
		.sidebar-controls {
			margin-top: 20px;
			display: flex;
			flex-direction: column;
			gap: 10px;
		}
		button {
			padding: 8px;
			background: #065fd4;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
        .tooltip-text {
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-text.show {
            opacity: 1;
        }
        .btn-floating-group {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .github-corner:hover .octo-arm {
          animation: octocat-wave 560ms ease-in-out;
        }
        @keyframes octocat-wave {
          0%, 100% { transform: rotate(0) }
          20%, 60% { transform: rotate(-25deg) }
          40%, 80% { transform: rotate(10deg) }
        }
        @media (max-width: 500px) {
          .github-corner:hover .octo-arm {
            animation: none;
          }
          .github-corner .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
          }
        }
        </style>
    </head>
    <body class="bg-dark">
<div class="container">
    <!-- 左側邊欄 -->
    <aside id="sidebar">
      <h2>播放清單</h2>
      <div id="playlist-items"></div>
      
      <!-- 操作按鈕 -->
      <div class="sidebar-controls">
        <input type="file" id="load-json" accept=".json" style="display:none;">
        <button onclick="document.getElementById('load-json').click()">載入 JSON</button>
        <button onclick="savePlaylist()">儲存目前清單</button>
        <button onclick="clearPlaylist()">清除清單</button>
      </div>
    </aside>

    <!-- 主要影片網格區域（原來的內容） -->
    <main id="main-grid">
      <!-- 原有的影片容器們會在這裡動態產生 -->
    </main>
  </div>

        <div class="container-fluid py-4 px-4">
            <div class="row justify-content-center">
                <div class="col-12">
                    <div id="videoContainer" class="row g-4 justify-content-center align-items-center" style="min-height: 90vh;">
                        <!-- Videos will be inserted here --></div>
                </div>
            </div>
        </div>
        <!-- Update floating buttons -->
        <div class="btn-floating-group">
            <button id="unmuteAllBtn" class="btn btn-success btn-lg shadow d-none">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-volume-up-fill"
                    viewBox="0 0 16 16"
                >
                    <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                    <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                    <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/>
                </svg>
                Unmute All
            </button>
            <button id="addVideoBtn" class="btn btn-warning btn-lg shadow">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-plus-lg"
                    viewBox="0 0 16 16"
                >
                    <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1"/>
                </svg>
                Add Video
            </button>
            <button id="shareBtn" class="btn btn-info btn-lg shadow">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-share-fill"
                    viewBox="0 0 16 16"
                >
                    <path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"/>
                </svg>
                Share
                <span class="tooltip-text">Link copied!</span>
            </button>
        </div>
        <div class="modal fade" id="addVideoModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add YouTube Video</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="youtubeUrl" class="form-label">Paste YouTube URL:</label>
                            <input
                                type="text"
                                class="form-control"
                                id="youtubeUrl"
                                placeholder="https://www.youtube.com/watch?v=..."
                            >
                        </div>
                        <div id="urlError" class="alert alert-danger mt-2 d-none">
                            Invalid YouTube URL
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="addVideoConfirm">Add Video</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bootstrap 5 JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
		// ==================== 新增功能：播放清單管理 ====================

let currentPlaylist = []; // [{title, id, url}, ...]

// 從 localStorage 載入上次儲存的清單（頁面載入時）
function loadSavedPlaylist() {
  const saved = localStorage.getItem('customPlaylist');
  if (saved) {
    currentPlaylist = JSON.parse(saved);
    renderPlaylist();
    loadVideosFromPlaylist(); // 自動載入上次清單的影片
  }
}

// 顯示側邊欄清單項目
function renderPlaylist() {
  const container = document.getElementById('playlist-items');
  container.innerHTML = '';
  
  currentPlaylist.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'playlist-item';
    div.textContent = item.title || `影片 ${index + 1}`;
    div.onclick = () => {
      // 點擊只播放單一影片（或你想要的行為）
      loadSingleVideo(item.id);
      highlightActiveItem(index);
    };
    container.appendChild(div);
  });
}

function highlightActiveItem(index) {
  document.querySelectorAll('.playlist-item').forEach((el, i) => {
    el.classList.toggle('active', i === index);
  });
}

// 從 JSON 檔案載入
document.getElementById('load-json').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const data = JSON.parse(event.target.result);
      if (!Array.isArray(data)) throw new Error("必須是陣列格式");
      
      currentPlaylist = data.map(item => ({
        title: item.title || "未命名",
        id: item.id || extractVideoId(item.url || ''),
        url: item.url || ''
      })).filter(item => item.id); // 過濾掉無效項目
      
      renderPlaylist();
      loadVideosFromPlaylist(); // 載入所有影片到網格
      alert('播放清單載入成功！');
    } catch(err) {
      alert('JSON 格式錯誤：' + err.message);
    }
  };
  reader.readAsText(file);
});

// 儲存到 localStorage
function savePlaylist() {
  if (currentPlaylist.length === 0) {
    alert('目前沒有清單可儲存');
    return;
  }
  localStorage.setItem('customPlaylist', JSON.stringify(currentPlaylist));
  alert('已儲存到瀏覽器本地！（localStorage）');
}

function clearPlaylist() {
  if (confirm('確定要清除播放清單？')) {
    currentPlaylist = [];
    localStorage.removeItem('customPlaylist');
    renderPlaylist();
    // 清空網格（呼叫原有清空函式或自己實作）
    document.getElementById('main-grid').innerHTML = '';
  }
}

// 從目前清單載入所有影片到網格（取代原有 ?videos= 邏輯）
function loadVideosFromPlaylist() {
  const ids = currentPlaylist.map(item => item.id).join(',');
  if (ids) {
    // 呼叫原有的載入函式，或直接用相同方式建立 iframe
    // 假設你原有程式有個 createPlayers(ids) 之類的函式
    // 這裡示範最簡單做法：
    const grid = document.getElementById('main-grid');
    grid.innerHTML = '';
    currentPlaylist.forEach(item => {
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${item.id}?autoplay=1&mute=1`;
      iframe.allow = "autoplay; encrypted-media";
      iframe.frameBorder = "0";
      iframe.allowFullscreen = true;
      grid.appendChild(iframe);
    });
  }
}

// 從單一 id 載入（當點擊側邊欄時，可選擇只播一個）
function loadSingleVideo(id) {
  // 可選擇：清空網格只放一個，或保持多個只靜音其他
  // 這裡示範簡單版：只播單一
  const grid = document.getElementById('main-grid');
  grid.innerHTML = '';
  const iframe = document.createElement('iframe');
  iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1`;
  iframe.style.width = '100%';
  iframe.style.height = '100vh';
  iframe.allow = "autoplay; encrypted-media";
  iframe.frameBorder = "0";
  iframe.allowFullscreen = true;
  grid.appendChild(iframe);
}

// 輔助：從 url 抽出 video id
function extractVideoId(url) {
  const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
  return (url.match(regex) || [])[1] || '';
}

// 頁面載入時執行
window.addEventListener('load', () => {
  loadSavedPlaylist();
  // 如果原本有處理 ?videos= 的程式碼，可保留，作為 fallback
});


        async function getVideoIds() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check for list parameter first
            const listUrl = urlParams.get('list');
            if (listUrl) {
                try {
                    const response = await fetch(listUrl);
                    const data = await response.json();
                    // Flatten the array of arrays and filter out any empty or invalid entries
                    console.log(data);
                    return data.flatMap(item => item).filter(id => id);
                } catch (error) {
                    console.error('Error fetching video list:', error);
                    return [];
                }
            }
            
            // Fall back to videos parameter if list is not present
            const videos = urlParams.get('videos');
            return videos ? videos.split(',') : [];
        }

        function getGridClass(totalVideos) {
            // Define grid classes based on number of videos
            switch (totalVideos) {
                case 1:
                    return 'col-12 col-lg-8 col-xl-6';
                case 2:
                    return 'col-12 col-md-6 col-lg-6';
                case 3:
                    return 'col-12 col-md-6 col-lg-4';
                case 4:
                    return 'col-12 col-md-6 col-lg-6 col-xl-3';
                case 5:
                case 6:
                    return 'col-12 col-md-6 col-lg-4';
                case 7:
                case 8:
                    return 'col-12 col-md-6 col-lg-4 col-xl-3';
                default:
                    return 'col-12 col-md-6 col-lg-4 col-xl-3';
            }
        }

        function createVideoEmbed(videoId, gridClass) {
            const colWrapper = document.createElement('div');
            colWrapper.className = gridClass;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'card shadow-sm h-100';
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body p-0';
            
            const videoWrapper = document.createElement('div');
            videoWrapper.className = 'ratio ratio-16x9';
            
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&mute=1`;
            iframe.className = 'border-0 youtube-player';
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
            iframe.allowFullscreen = true;
            
            videoWrapper.appendChild(iframe);
            cardBody.appendChild(videoWrapper);
            wrapper.appendChild(cardBody);
            colWrapper.appendChild(wrapper);
            return colWrapper;
        }

        async function initialize() {
            const container = document.getElementById('videoContainer');
            const unmuteAllBtn = document.getElementById('unmuteAllBtn');
            const shareBtn = document.getElementById('shareBtn');
            
            // Get video IDs asynchronously
            const videoIds = await getVideoIds();
            
            // Create videos section
            if (videoIds.length > 0) {
                const gridClass = getGridClass(videoIds.length);
                videoIds.forEach(videoId => {
                    container.appendChild(createVideoEmbed(videoId, gridClass));
                });
            } else {
                // If no videos, add spacing and hide share button
                const videoArea = document.createElement('div');
                videoArea.style.minHeight = '60vh';
                container.appendChild(videoArea);
                shareBtn.classList.add('d-none');
            }

            // Always add the description at the bottom
            const alert = document.createElement('div');
            alert.className = 'alert alert-info text-center mt-4';
            alert.innerHTML = `
                <h5 class="mb-0 text-dark">Add videos using either:</h5>
                <hr>
                <p class="mb-0 text-dark">1. URL parameter "videos" with comma-separated YouTube IDs:<br>
                <code>?videos=dQw4w9WgXcQ,jNQXAC9IVRw</code></p>
                <p class="mt-2 mb-0 text-dark">2. URL parameter "list" pointing to an API that returns video IDs:<br>
                <code>?list=https://api.example.com/videos</code></p>
            `;
            container.appendChild(alert);
        }

        // Load YouTube IFrame API
        let tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        let firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let players = [];

        // This function will be called by YouTube API when it's ready
        function onYouTubeIframeAPIReady() {
            // Initialize players for all iframes
            document.querySelectorAll('.youtube-player').forEach((iframe, index) => {
                players[index] = new YT.Player(iframe, {
                    events: {
                        'onReady': onPlayerReady
                    }
                });
            });
        }

        function onPlayerReady(event) {
            // Start playing when ready (will be muted)
            event.target.playVideo();
        }

        document.getElementById('unmuteAllBtn').addEventListener('click', function() {
            players.forEach(player => {
                if (player.unMute) {
                    player.unMute();
                }
            });
            // Change button appearance after unmuting
            this.classList.replace('btn-success', 'btn-secondary');
            this.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-mute-fill" viewBox="0 0 16 16">
                    <path d="M6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06zm7.137 2.096a.5.5 0 0 1 0 .708L12.207 8l1.647 1.646a.5.5 0 0 1-.708.708L11.5 8.707l-1.646 1.647a.5.5 0 0 1-.708-.708L10.793 8 9.146 6.354a.5.5 0 1 1 .708-.708L11.5 7.293l1.646-1.647a.5.5 0 0 1 .708 0z"/>
                </svg>
                Muted
            `;
            this.disabled = true;
        });

        // Add share button functionality
        document.getElementById('shareBtn').addEventListener('click', async function() {
            const tooltip = this.querySelector('.tooltip-text');
            
            try {
                await navigator.clipboard.writeText(window.location.href);
                
                // Show tooltip
                tooltip.classList.add('show');
                
                // Hide tooltip after 2 seconds
                setTimeout(() => {
                    tooltip.classList.remove('show');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy URL:', err);
                tooltip.textContent = 'Failed to copy link';
                tooltip.classList.add('show');
                setTimeout(() => {
                    tooltip.classList.remove('show');
                    tooltip.textContent = 'Link copied!';
                }, 2000);
            }
        });

        // Add video modal functionality
        const addVideoModal = new bootstrap.Modal(document.getElementById('addVideoModal'));
        const urlInput = document.getElementById('youtubeUrl');
        const urlError = document.getElementById('urlError');

        document.getElementById('addVideoBtn').addEventListener('click', () => {
            urlInput.value = '';
            urlError.classList.add('d-none');
            addVideoModal.show();
        });

        document.getElementById('addVideoConfirm').addEventListener('click', () => {
            const url = urlInput.value.trim();
            let videoId = '';

            // Try to extract video ID from various YouTube URL formats
            try {
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    if (url.includes('youtube.com/watch?v=')) {
                        videoId = new URL(url).searchParams.get('v');
                    } else if (url.includes('youtu.be/')) {
                        videoId = url.split('youtu.be/')[1].split('?')[0];
                    }
                }
            } catch (e) {
                console.error('Error parsing URL:', e);
            }

            if (!videoId) {
                urlError.classList.remove('d-none');
                return;
            }

            // Add the video to the current URL
            const currentUrl = new URL(window.location.href);
            const currentVideos = currentUrl.searchParams.get('videos');
            
            if (currentVideos) {
                currentUrl.searchParams.set('videos', currentVideos + ',' + videoId);
            } else {
                currentUrl.searchParams.set('videos', videoId);
            }

            // Reload the page with the new video
            window.location.href = currentUrl.toString();
        });

        // Clear error when input changes
        urlInput.addEventListener('input', () => {
            urlError.classList.add('d-none');
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initialize().catch(error => {
                console.error('Error initializing application:', error);
            });
        });
        </script>
    </body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="多格 YouTube 同步播放器，支援多分頁清單、線上載入、網址分享" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />

  <title>YT 多格播放器 - 進階版</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    'name': 'YT 多格播放器',
    'short_name': 'YT MultiView',
    'description': '多格同步 YouTube 播放器',
    'start_url': './?utm_source=pwa',
    'display': 'standalone',
    'background_color': '#000000',
    'theme_color': '#a81c1c',
    'orientation': 'any',
    'icons': [
      {
        'src': 'https://via.placeholder.com/192x192/000/fff?text=YT',
        'sizes': '192x192',
        'type': 'image/png',
        'purpose': 'any maskable'
      },
      {
        'src': 'https://via.placeholder.com/512x512/000/fff?text=YT',
        'sizes': '512x512',
        'type': 'image/png',
        'purpose': 'any maskable'
      }
    ]
  }" />

  <!-- 建議自行替換成真實圖標，並放在專案根目錄 -->
  <!-- <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" /> -->

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent; /* 移除行動裝置點擊反白 */
    }

    html, body {
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: #0f0f0f;
      color: #ddd;
      overscroll-behavior: none; /* 防止 iOS 橡皮筋效果 */
      touch-action: manipulation; /* 改善觸控體驗 */
    }

    body {
      font-size: 16px; /* 基礎字體大小 */
      height: 100vh;
      overflow: hidden;
    }

    #main {
      height: 100vh;
      background: #000;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #controls {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      z-index: 100;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 95%;
      transition: opacity 0.5s;
    }

    #controls.hidden {
      opacity: 0;
      pointer-events: none;
    }

    button {
      padding: 0.6rem 1rem;
      background: #a81c1c;
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.95rem;
      min-width: 2.8rem;
      transition: all 0.25s ease;
      touch-action: manipulation;
    }

    button:hover, button:active {
      background: #c41e1e;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(168,28,28,0.5);
    }

    #add-btn {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 4.2rem;
      height: 4.2rem;
      border-radius: 50%;
      background: #a81c1c;
      color: white;
      font-size: 2.5rem;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(168,28,28,0.6);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s ease;
    }

    #add-btn:hover, #add-btn:active {
      background: #c41e1e;
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(168,28,28,0.6);
    }

    #grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 0.75rem;
      padding: 1rem;
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    .video-wrapper {
      position: relative;
      background: #111;
      border-radius: 0.75rem;
      overflow: hidden;
      aspect-ratio: 16 / 9;
    }

    .video-wrapper iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .close-btn,
    .tab-remove,
    .remove-item,
    .close-overlay {
      background: rgba(30,30,30,0.7);
      color: #aaa;
      border: none;
      border-radius: 50%;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      width: 2.2rem;
      height: 2.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      opacity: 0.8;
    }

    .close-btn:hover,
    .tab-remove:hover,
    .remove-item:hover,
    .close-overlay:hover {
      background: #a81c1c;
      color: white;
      opacity: 1;
      transform: scale(1.1);
    }

    .close-btn { position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10; }
    .tab-remove { width: 1.8rem; height: 1.8rem; margin-left: 0.3rem; margin-right: 0.4rem; }
    .remove-item { width: 1.6rem; height: 1.6rem; }

    #no-video-msg {
      color: #777;
      font-size: 1.4rem;
      text-align: center;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.88);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .overlay-content {
      width: 92%;
      max-width: 920px;
      background: #181818;
      border-radius: 1rem;
      padding: 1.5rem;
      max-height: 88vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.7);
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
    }

    /* 行動裝置專屬調整 */
    @media (max-width: 768px) {
      body { font-size: 15px; }
      button { padding: 0.7rem 1.1rem; font-size: 0.92rem; min-width: 3rem; }
      #add-btn { width: 4.8rem; height: 4.8rem; font-size: 2.8rem; bottom: 1.2rem; right: 1.2rem; }
      #grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.6rem; padding: 0.8rem; }
      .close-btn, .tab-remove, .remove-item { width: 2rem; height: 2rem; font-size: 1rem; }
      .overlay-content { padding: 1.2rem; width: 96%; }
    }

    @media (max-width: 480px) {
      button { padding: 0.65rem 1rem; font-size: 0.9rem; }
      #controls { padding: 0.6rem 1rem; gap: 0.6rem; }
      #add-btn { width: 4.2rem; height: 4.2rem; font-size: 2.4rem; }
    }
  </style>
</head>
<body>
  <div id="main">
    <div id="controls">
      <button onclick="playAll()">全部播放</button>
      <button onclick="pauseAll()">全部暫停</button>
      <button onclick="toggleMuteAll()">靜音/取消靜音</button>
      <button onclick="clearAllVideos()">清除所有影片</button>
      <button onclick="copyCurrentVideosUrl()">複製目前影片設定</button>
    </div>

    <div id="grid"></div>
    <div id="no-video-msg">點擊右下角 + 按鈕開啟播放清單</div>

    <button id="add-btn">+</button>
  </div>

  <!-- 主播放清單 Overlay -->
  <div id="playlist-overlay" class="overlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <h2>播放清單管理</h2>
        <button class="close-overlay" onclick="closeOverlay()">×</button>
      </div>

      <input type="text" id="search-input" placeholder="搜尋所有播放清單的影片標題..." />

      <div id="search-results"></div>

      <div class="tab-container" id="tab-buttons"></div>

      <div id="tab-contents"></div>

      <div class="load-buttons">
        <button onclick="loadLocalJson()">從本地加入</button>
        <button onclick="showOnlinePlaylistOverlay()">從線上加入</button>
        <button onclick="saveCurrentTab()">儲存此分頁</button>
        <button onclick="saveAllTabs()">儲存所有分頁</button>
        <button onclick="showNewTabOverlay()">新增分頁</button>
        <button onclick="showAddVideoOverlay()">加入影片到此分頁</button>
      </div>
    </div>
  </div>

  <!-- 線上播放清單 Overlay -->
  <div id="online-playlist-overlay" class="overlay" style="z-index:350;">
    <div class="overlay-content">
      <div class="overlay-header">
        <h2>線上播放清單</h2>
        <button class="close-overlay" onclick="document.getElementById('online-playlist-overlay').style.display='none'">×</button>
      </div>

      <div id="online-repo-info" style="margin-bottom:12px; color:#aaa; font-size:0.9rem;"></div>

      <div style="margin-bottom:16px; display:flex; gap:10px; flex-wrap:wrap;">
        <input type="text" id="online-search" placeholder="搜尋線上清單名稱..." style="flex:1;" />
        <button onclick="showOnlinePlaylistOverlay()" class="small-btn">重新載入</button>
        <button onclick="useOriginalRepo()" class="small-btn">使用原版</button>
      </div>

      <div id="online-files-list" style="max-height:45vh; overflow-y:auto;"></div>

      <div style="margin-top:24px; padding-top:16px; border-top:1px solid #444;">
        <h3 style="margin-bottom:12px;">加入播放清單 JSON</h3>
        <input type="text" id="json-url" placeholder="輸入 JSON 完整網址 (支援 GitHub raw 等)" style="width:100%; padding:10px; margin-bottom:16px; background:#222; border:1px solid #444; color:white; border-radius:6px;" />
        <button onclick="addJsonFromUrl()" class="small-btn">加入到目前分頁</button>
      </div>
    </div>
  </div>

  <!-- 新增分頁輸入 -->
  <div id="new-tab-overlay" class="overlay" style="z-index:400;">
    <div id="new-tab-box">
      <h3>建立新分頁</h3>
      <input type="text" id="new-tab-name" placeholder="請輸入分頁名稱" style="width:100%; padding:12px; margin:20px 0; background:#222; border:1px solid #444; color:white; border-radius:6px;" />
      <div style="display:flex; gap:12px; justify-content:center; margin-top:20px;">
        <button onclick="document.getElementById('new-tab-overlay').style.display='none'" class="small-btn">取消</button>
        <button onclick="createNewTab()" class="small-btn">建立</button>
      </div>
    </div>
  </div>

  <!-- 加入單一影片 overlay -->
  <div id="add-video-overlay" class="overlay" style="z-index:400;">
    <div id="add-video-box">
      <h3 style="margin-bottom:20px;">加入新影片到目前分頁</h3>
      <input type="text" id="new-title" placeholder="影片標題" style="width:100%; padding:10px; margin-bottom:12px; background:#222; border:1px solid #444; color:white; border-radius:6px;" />
      <input type="text" id="new-id" placeholder="YouTube ID 或完整網址" style="width:100%; padding:10px; margin-bottom:20px; background:#222; border:1px solid #444; color:white; border-radius:6px;" />
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
        <button onclick="document.getElementById('add-video-overlay').style.display='none'" class="small-btn">取消</button>
        <button onclick="addVideoToCurrentTab()" class="small-btn">加入</button>
      </div>
    </div>
  </div>

  <!-- 瞬時訊息 -->
  <div id="message-bar"></div>

  <input type="file" id="local-json-input" accept=".json" style="display:none" />

  <!-- PWA Service Worker 註冊 -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(new URL('./sw.js', import.meta.url), {scope: './'})
          .then(reg => console.log('Service Worker 註冊成功', reg))
          .catch(err => console.log('Service Worker 註冊失敗', err));
      });
    }
  </script>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let players = {};
    let isMuted = true;
    let currentPlaylists = [];
    let currentTabIndex = -1;

    // 自動偵測 GitHub 相關網址
    function getGitHubRepoApiUrl() {
      const currentUrl = window.location.href;
      const githubMatch = currentUrl.match(/github\.com\/([^/]+)\/([^/]+)/i);

      if (githubMatch && githubMatch.length === 3) {
        const username = githubMatch[1];
        const repo = githubMatch[2].split('#')[0].split('?')[0].split('/')[0];
        return `https://api.github.com/repos/${username}/${repo}/git/trees/main?recursive=1`;
      }

      return "https://api.github.com/repos/alanfox2000software/ytcustomplayer/git/trees/main?recursive=1";
    }

    function getRawBaseUrl() {
      const apiUrl = getGitHubRepoApiUrl();
      const match = apiUrl.match(/repos\/([^/]+)\/([^/]+)\//);
      if (match) {
        const username = match[1];
        const repo = match[2];
        return `https://raw.githubusercontent.com/${username}/${repo}/main/`;
      }
      return "https://raw.githubusercontent.com/alanfox2000software/ytcustomplayer/main/";
    }

    function getPagesBaseUrl() {
      const currentUrl = window.location.href;
      const githubMatch = currentUrl.match(/github\.com\/([^/]+)\/([^/]+)/i);

      if (githubMatch && githubMatch.length === 3) {
        const username = githubMatch[1];
        const repo = githubMatch[2].split('#')[0].split('?')[0].split('/')[0];
        return `https://${username}.github.io/${repo}/`;
      }

      return "https://alanfox2000software.github.io/ytcustomplayer/";
    }

    const GITHUB_TREE_URL = getGitHubRepoApiUrl();
    const RAW_BASE = getRawBaseUrl();
    const PAGES_BASE_URL = getPagesBaseUrl();

    console.log("API:", GITHUB_TREE_URL);
    console.log("RAW:", RAW_BASE);
    console.log("Pages:", PAGES_BASE_URL);

    const controls = document.getElementById("controls");
    let hideTimer = null;

    function showControls() {
      controls.classList.remove("hidden");
      clearTimeout(hideTimer);
      hideTimer = setTimeout(() => controls.classList.add("hidden"), 4000);
    }

    document.addEventListener("mousemove", showControls);
    document.addEventListener("click", showControls);
    document.addEventListener("touchstart", showControls, { passive: true });

    const playlistOverlay = document.getElementById("playlist-overlay");
    const addBtn = document.getElementById("add-btn");

    addBtn.onclick = () => {
      playlistOverlay.style.display = "flex";
      renderTabs();
    };

    function closeOverlay() {
      playlistOverlay.style.display = "none";
      document.getElementById("search-input").value = "";
      document.getElementById("search-results").innerHTML = "";
    }

    function onYouTubeIframeAPIReady() {
      console.log("YouTube IFrame API Ready");
      loadVideosFromUrl();
    }

    function loadVideosFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const videosParam = params.get("videos");

      if (videosParam) {
        const videoIds = videosParam.split(",").map(id => id.trim()).filter(id => id.length === 11);
        if (videoIds.length > 0) {
          videoIds.forEach(id => addVideoToGrid(id, "從網址載入"));
          showMessage(`已從網址載入 ${videoIds.length} 部影片`, "success");
        }
      }
    }

    function copyCurrentVideosUrl() {
      const videoIds = Object.keys(players);
      if (videoIds.length === 0) {
        showMessage("目前沒有任何影片", "error");
        return;
      }

      const shareUrl = `${PAGES_BASE_URL}?videos=${videoIds.join(",")}`;

      navigator.clipboard.writeText(shareUrl).then(() => {
        showMessage("已複製目前影片設定連結到剪貼簿", "success");
      }).catch(err => {
        showMessage("複製失敗：" + err.message, "error");
      });
    }

    async function showOnlinePlaylistOverlay() {
      const container = document.getElementById("online-files-list");
      const infoDiv = document.getElementById("online-repo-info");
      container.innerHTML = '<div style="padding:20px;text-align:center;color:#aaa;">正在載入線上播放清單...</div>';

      document.getElementById("online-playlist-overlay").style.display = "flex";

      const isOriginal = GITHUB_TREE_URL.includes("alanfox2000software");
      infoDiv.innerHTML = `目前載入自：${isOriginal ? '原版儲存庫' : '您 Fork 的儲存庫'}<br>
        <small style="color:#888;">API: ${GITHUB_TREE_URL.split('/repos/')[1] || '...'}</small>`;

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 12000);

        const response = await fetch(GITHUB_TREE_URL, {
          method: 'GET',
          headers: {
            'Accept': 'application/vnd.github.v3+json',
            'User-Agent': 'yt-multiviewer-browser'
          },
          mode: 'cors',
          cache: 'no-cache',
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          let msg = `GitHub API 錯誤: ${response.status}`;
          if (response.status === 403) msg += " (速率限制，請稍後再試或使用 VPN)";
          if (response.status === 404) msg += " (找不到儲存庫或 main 分支)";
          throw new Error(msg);
        }

        const data = await response.json();
        const tree = data.tree || [];

        const jsonFiles = tree
          .filter(item => item.type === "blob" && item.path?.startsWith("playlist/") && item.path.endsWith(".json"))
          .map(item => item.path.replace(/^playlist\//, ""));

        container.innerHTML = "";

        if (jsonFiles.length === 0) {
          container.innerHTML = '<div style="padding:20px;color:#888;text-align:center;">目前 playlist 資料夾沒有 .json 檔案</div>';
          return;
        }

        jsonFiles.sort().forEach(filename => {
          const item = document.createElement("div");
          item.className = "online-file-item";
          item.textContent = filename;
          item.style.cursor = "pointer";
          item.addEventListener('click', () => loadOnlinePlaylist(filename));
          container.appendChild(item);
        });

        document.getElementById("online-search").oninput = function() {
          const keyword = this.value.trim().toLowerCase();
          Array.from(container.children).forEach(el => {
            el.style.display = el.textContent.toLowerCase().includes(keyword) ? "" : "none";
          });
        };

      } catch (err) {
        let msg = err.message || "載入失敗";
        if (err.name === 'AbortError') msg = "載入超時（12秒）";
        container.innerHTML = `
          <div style="padding:20px; color:#ff6666; text-align:center;">
            ${msg}<br>
            <small>可嘗試點擊下方按鈕切換原版儲存庫</small>
          </div>
        `;
        console.error("GitHub API 載入失敗:", err);
      }
    }

    async function loadOnlinePlaylist(filename) {
      let cleanUrl = `${RAW_BASE}playlist/${filename}`;
      cleanUrl = cleanUrl.replace(/([^:]\/)\/+/g, "$1");
      cleanUrl = cleanUrl.replace(/^https?:\/+/, 'https://');

      console.log("嘗試載入 JSON:", cleanUrl);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const res = await fetch(cleanUrl, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache',
          redirect: 'follow',
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status} - ${res.statusText}`);
        }

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (parseErr) {
          throw new Error("JSON 解析失敗：" + parseErr.message);
        }

        addNewPlaylistGroup(data);
        document.getElementById("online-playlist-overlay").style.display = "none";
        showMessage(`成功載入：${filename}`, "success");

      } catch (e) {
        let msg = "載入失敗";
        if (e.name === 'AbortError') msg = "載入超時（10秒）";
        else if (e.message.includes("404")) msg = "找不到檔案";
        else msg = e.message;

        showMessage(`${msg}：${filename}`, "error");
        console.error("載入 JSON 失敗:", e, "\nURL:", cleanUrl);
      }
    }

    // 從任意 JSON URL 加入播放清單
    async function addJsonFromUrl() {
      const urlInput = document.getElementById("json-url");
      const url = urlInput.value.trim();

      if (!url) {
        showMessage("請輸入 JSON 完整網址", "error");
        return;
      }

      if (!url.startsWith("https://")) {
        showMessage("網址必須以 https:// 開頭", "error");
        return;
      }

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const res = await fetch(url, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache',
          redirect: 'follow',
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status} - ${res.statusText}`);
        }

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (parseErr) {
          throw new Error("JSON 解析失敗：" + parseErr.message);
        }

        addNewPlaylistGroup(data);
        document.getElementById("online-playlist-overlay").style.display = "none";
        showMessage("已成功從網址加入播放清單", "success");
        urlInput.value = "";

      } catch (e) {
        let msg = "加入失敗";
        if (e.name === 'AbortError') msg = "載入超時（10秒）";
        else if (e.message.includes("404")) msg = "找不到該 JSON 檔案";
        else if (e.message.includes("CORS")) msg = "CORS 錯誤（該網址不支援跨域請求）";
        else msg = e.message;

        showMessage(msg, "error");
        console.error("從 URL 加入 JSON 失敗:", e, "\nURL:", url);
      }
    }

    function useOriginalRepo() {
      if (confirm("確定要切換回原版 alanfox2000software 儲存庫嗎？")) {
        localStorage.setItem('forceOriginalRepo', 'true');
        location.reload();
      }
    }

    if (localStorage.getItem('forceOriginalRepo') === 'true') {
      localStorage.removeItem('forceOriginalRepo');
      showMessage("已切換回原版儲存庫，請重新點擊「從線上加入」", "success");
    }

    function addVideoToGrid(videoId, title = "") {
      if (players[videoId]) return;

      document.getElementById("no-video-msg").style.display = "none";

      const wrapper = document.createElement("div");
      wrapper.className = "video-wrapper";
      wrapper.id = `wrapper-${videoId}`;

      const closeBtn = document.createElement("button");
      closeBtn.className = "close-btn";
      closeBtn.textContent = "×";
      closeBtn.onclick = () => removeVideo(videoId);
      wrapper.appendChild(closeBtn);

      const playerDiv = document.createElement("div");
      playerDiv.id = `player-${videoId}`;
      wrapper.appendChild(playerDiv);

      document.getElementById("grid").appendChild(wrapper);

      const p = new YT.Player(`player-${videoId}`, {
        height: "100%",
        width: "100%",
        videoId: videoId,
        playerVars: { autoplay: 1, mute: isMuted ? 1 : 0, rel: 0, modestbranding: 1, controls: 1 },
        events: { onReady: (e) => e.target.playVideo() }
      });

      players[videoId] = p;
    }

    function removeVideo(videoId) {
      const wrapper = document.getElementById(`wrapper-${videoId}`);
      if (wrapper) {
        players[videoId]?.destroy();
        delete players[videoId];
        wrapper.remove();
        if (Object.keys(players).length === 0) {
          document.getElementById("no-video-msg").style.display = "flex";
        }
      }
    }

    function playAll()    { Object.values(players).forEach(p => p?.playVideo?.()); showControls(); }
    function pauseAll()   { Object.values(players).forEach(p => p?.pauseVideo?.()); showControls(); }
    function toggleMuteAll() {
      isMuted = !isMuted;
      Object.values(players).forEach(p => isMuted ? p?.mute?.() : p?.unMute?.());
      showControls();
    }
    function clearAllVideos() {
      Object.keys(players).forEach(id => removeVideo(id));
      showControls();
    }

    function copyCurrentVideosUrl() {
      const videoIds = Object.keys(players);
      if (videoIds.length === 0) {
        showMessage("目前沒有任何影片", "error");
        return;
      }

      const shareUrl = `${PAGES_BASE_URL}?videos=${videoIds.join(",")}`;

      navigator.clipboard.writeText(shareUrl).then(() => {
        showMessage("已複製目前影片設定連結到剪貼簿", "success");
      }).catch(err => {
        showMessage("複製失敗：" + err.message, "error");
      });
    }

    document.getElementById("search-input").addEventListener("input", doSearch);

    function doSearch() {
      const keyword = document.getElementById("search-input").value.trim().toLowerCase();
      const container = document.getElementById("search-results");
      container.innerHTML = "";

      if (!keyword) return;

      const results = [];
      currentPlaylists.forEach((pl, plIndex) => {
        pl.items.forEach((item, itemIndex) => {
          if (item.title.toLowerCase().includes(keyword)) {
            results.push({ ...item, playlistName: pl.playlist, plIndex, itemIndex });
          }
        });
      });

      if (results.length === 0) {
        container.innerHTML = "<div style='padding:12px;color:#777'>無符合結果</div>";
        return;
      }

      results.slice(0, 50).forEach(r => {
        const div = document.createElement("div");
        div.className = "search-item";
        div.textContent = `[${r.playlistName}] ${r.title}`;
        div.title = r.title;
        div.onclick = () => addVideoToGrid(r.id, r.title);
        container.appendChild(div);
      });
    }

    function showNewTabOverlay() {
      document.getElementById("new-tab-overlay").style.display = "flex";
      document.getElementById("new-tab-name").value = "";
      document.getElementById("new-tab-name").focus();
    }

    function createNewTab() {
      const name = document.getElementById("new-tab-name").value.trim();
      if (!name) {
        showMessage("請輸入分頁名稱", "error");
        return;
      }

      currentPlaylists.push({
        playlist: name,
        items: []
      });

      document.getElementById("new-tab-overlay").style.display = "none";
      renderTabs();
      switchTab(currentPlaylists.length - 1);
      showMessage(`已新增分頁：「${name}」`, "success");
    }

    function showAddVideoOverlay() {
      if (currentTabIndex < 0) {
        showMessage("請先選擇一個分頁", "error");
        return;
      }
      document.getElementById("add-video-overlay").style.display = "flex";
      document.getElementById("new-title").value = "";
      document.getElementById("new-id").value = "";
    }

    function addVideoToCurrentTab() {
      const title = document.getElementById("new-title").value.trim();
      let input = document.getElementById("new-id").value.trim();

      if (!title || !input) {
        showMessage("標題與 ID/網址皆為必填", "error");
        return;
      }

      let videoId = input;
      if (input.includes("youtube.com") || input.includes("youtu.be")) {
        const m = input.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);
        videoId = m ? m[1] : "";
      }

      if (!videoId || videoId.length !== 11) {
        showMessage("無法解析有效的 YouTube 影片 ID", "error");
        return;
      }

      if (currentPlaylists[currentTabIndex].items.some(i => i.id === videoId)) {
        showMessage("此影片 ID 已存在於目前分頁", "error");
        return;
      }

      currentPlaylists[currentTabIndex].items.push({ title, id: videoId });
      document.getElementById("add-video-overlay").style.display = "none";
      renderTabs();
      showMessage(`已加入：「${title}」`, "success");
    }

    document.getElementById("local-json-input").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = event => {
        try {
          const data = JSON.parse(event.target.result);
          addNewPlaylistGroup(data);
          showMessage("本地檔案載入成功", "success");
        } catch(err) {
          showMessage("JSON 格式錯誤：" + err.message, "error");
        }
      };
      reader.readAsText(file);
    });

    function loadLocalJson() {
      document.getElementById("local-json-input").click();
    }

    function addNewPlaylistGroup(data) {
      let groups = [];

      if (Array.isArray(data)) {
        if (data[0]?.playlist && Array.isArray(data[0].items)) {
          groups = data;
        } else {
          groups = [{
            playlist: "新載入清單 " + new Date().toLocaleDateString(),
            items: data.filter(i => i.id).map(i => ({title: i.title || "未命名", id: i.id}))
          }];
        }
      }

      if (groups.length === 0) {
        showMessage("無有效資料", "error");
        return;
      }

      const existingNames = new Set(currentPlaylists.map(p => p.playlist));
      const newGroups = [];

      groups.forEach(g => {
        let name = g.playlist;
        let counter = 1;
        while (existingNames.has(name)) {
          name = `${g.playlist} (${counter++})`;
        }
        newGroups.push({ ...g, playlist: name });
        existingNames.add(name);
      });

      currentPlaylists.push(...newGroups);
      renderTabs();
      showMessage(`已加入 ${newGroups.length} 個分頁（避免重名）`, "success");
    }

    function renderTabs() {
      const tabButtons = document.getElementById("tab-buttons");
      const tabContents = document.getElementById("tab-contents");
      tabButtons.innerHTML = "";
      tabContents.innerHTML = "";

      if (currentPlaylists.length === 0) {
        tabButtons.innerHTML = "<div style='padding:12px;color:#777'>尚未載入任何播放清單</div>";
        return;
      }

      currentPlaylists.forEach((pl, index) => {
        const tabWrapper = document.createElement("div");
        tabWrapper.className = "tab-wrapper";

        const tab = document.createElement("div");
        tab.className = "tab";
        tab.textContent = pl.playlist || `清單 ${index+1}`;
        tab.dataset.index = index;
        tab.onclick = () => switchTab(index);
        tabWrapper.appendChild(tab);

        const removeTabBtn = document.createElement("button");
        removeTabBtn.className = "tab-remove";
        removeTabBtn.textContent = "×";
        removeTabBtn.onclick = (e) => {
          e.stopPropagation();
          currentPlaylists.splice(index, 1);
          renderTabs();
          if (currentTabIndex >= currentPlaylists.length) {
            switchTab(currentPlaylists.length - 1);
          }
          showMessage("分頁已移除", "success");
        };
        tabWrapper.appendChild(removeTabBtn);

        tabButtons.appendChild(tabWrapper);

        const content = document.createElement("div");
        content.className = "tab-content";
        content.id = `tab-content-${index}`;

        pl.items.forEach((item, itemIndex) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "playlist-item";

          const titleSpan = document.createElement("span");
          titleSpan.textContent = item.title;
          titleSpan.title = item.title;
          titleSpan.onclick = (e) => {
            e.stopPropagation();
            addVideoToGrid(item.id, item.title);
          };

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-item";
          removeBtn.textContent = "×";
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            pl.items.splice(itemIndex, 1);
            renderTabs();
            showMessage("項目已移除", "success");
          };

          itemDiv.appendChild(titleSpan);
          itemDiv.appendChild(removeBtn);
          content.appendChild(itemDiv);
        });

        tabContents.appendChild(content);
      });

      if (currentTabIndex < 0 && currentPlaylists.length > 0) {
        switchTab(0);
      } else if (currentTabIndex >= currentPlaylists.length) {
        switchTab(currentPlaylists.length - 1);
      } else if (currentTabIndex >= 0) {
        switchTab(currentTabIndex);
      }
    }

    function switchTab(index) {
      currentTabIndex = parseInt(index);
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

      const activeTab = document.querySelector(`.tab[data-index="${index}"]`);
      if (activeTab) activeTab.classList.add("active");
      document.getElementById(`tab-content-${index}`)?.classList.add("active");
    }

    function showMessage(text, type = "success") {
      const bar = document.getElementById("message-bar");
      bar.textContent = text;
      bar.className = `show ${type}`;
      setTimeout(() => bar.classList.remove("show"), 2500);
    }

    function saveCurrentTab() {
      if (currentTabIndex < 0 || currentTabIndex >= currentPlaylists.length) {
        showMessage("請先選擇一個分頁", "error");
        return;
      }

      const data = [currentPlaylists[currentTabIndex]];
      downloadJson(data, `playlist_${currentPlaylists[currentTabIndex].playlist || "tab"}_${new Date().toISOString().slice(0,10)}.json`);
      showMessage("此分頁已儲存為 JSON", "success");
    }

    function saveAllTabs() {
      if (currentPlaylists.length === 0) {
        showMessage("沒有可儲存的播放清單", "error");
        return;
      }
      downloadJson(currentPlaylists, `all_playlists_${new Date().toISOString().slice(0,10)}.json`);
      showMessage("所有分頁已儲存為 JSON", "success");
    }

    function downloadJson(data, filename) {
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>